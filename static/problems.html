<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë¬¸ì œ ëª©ë¡ - í•™ìƒ ë‹µì•ˆ ì œì¶œ ì‹œìŠ¤í…œ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-name {
        font-size: 16px;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .problems-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .problem-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        border-left: 4px solid #667eea;
      }

      .problem-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .problem-header {
        margin-bottom: 15px;
      }

      .problem-id {
        color: #667eea;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .problem-title {
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
      }

      .problem-content {
        color: #667eea;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 20px;
        font-style: italic;
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .problem-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .max-score {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
      }

      .solve-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.3s;
      }

      .solve-btn:hover {
        transform: translateY(-2px);
      }

      .submission-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-submitted {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-not-submitted {
        background: #fff3e0;
        color: #f57c00;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #f44336;
      }

      .section-title {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
      }

      .section-subtitle {
        color: #666;
        font-size: 16px;
        margin-bottom: 30px;
      }

      .tutorial-notice {
        background: #e3f2fd;
        border: 2px solid #2196f3;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
      }

      .tutorial-notice h3 {
        color: #1976d2;
        margin-bottom: 10px;
      }

      .tutorial-notice p {
        color: #424242;
        margin-bottom: 15px;
      }

      .tutorial-btn {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        margin: 0 5px;
        transition: background 0.3s;
      }

      .tutorial-btn:hover {
        background: #1976d2;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <h1>í•™ìƒ ë‹µì•ˆ ì œì¶œ ì‹œìŠ¤í…œ</h1>
        <div class="user-info">
          <span class="user-name" id="userName">ë¡œë”© ì¤‘...</span>
          <button class="logout-btn" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div id="tutorialNotice" class="tutorial-notice" style="display: none;">
        <h3>ğŸ“ íŠœí† ë¦¬ì–¼ì„ ë¨¼ì € ì§„í–‰í•´ë³´ì„¸ìš”!</h3>
        <p>ì½”ë“œ ì½ê¸° ê³¼ì œê°€ ì²˜ìŒì´ì‹ ê°€ìš”? íŠœí† ë¦¬ì–¼ì„ í†µí•´ ë¬¸ì œ í’€ì´ ë°©ë²•ì„ ìµí˜€ë³´ì„¸ìš”.</p>
        <button class="tutorial-btn" id="start-tutorial">íŠœí† ë¦¬ì–¼ ì‹œì‘í•˜ê¸°</button>
        <button class="tutorial-btn" id="skip-tutorial">ê±´ë„ˆë›°ê³  ë¬¸ì œ í’€ê¸°</button>
      </div>

      <h2 class="section-title">ë¬¸ì œ ëª©ë¡</h2>
      <p class="section-subtitle">ì•„ë˜ ë¬¸ì œë“¤ì„ í•˜ë‚˜ì”© í•´ê²°í•´ë´ìš”!</p>

      <div id="loadingMessage" class="loading">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div id="errorMessage" class="error" style="display: none"></div>
      <div id="problemsGrid" class="problems-grid" style="display: none"></div>
    </div>

    <script>
      // íŠœí† ë¦¬ì–¼ ì™„ë£Œ ìƒíƒœ í™•ì¸
      function checkTutorialStatus() {
        return localStorage.getItem("tutorial_completed") === "true";
      }

      // ì¸ì¦ í™•ì¸
      function checkAuth() {
        const token = localStorage.getItem("access_token");
        const userName = localStorage.getItem("user_name");

        if (!token) {
          window.location.href = "/";
          return false;
        }

        document.getElementById("userName").textContent = userName || "ì‚¬ìš©ì";
        return true;
      }

      // ë¡œê·¸ì•„ì›ƒ
      function logout() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("user_name");
        localStorage.removeItem("tutorial_completed");
        window.location.href = "/";
      }

      // API í˜¸ì¶œ í—¬í¼
      async function apiCall(url, options = {}) {
        const token = localStorage.getItem("access_token");

        const defaultOptions = {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            ...options.headers,
          },
        };

        const response = await fetch(url, { ...options, ...defaultOptions });

        if (response.status === 401) {
          // í† í°ì´ ë§Œë£Œëœ ê²½ìš°
          logout();
          return null;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
      }

      // ìŠ¬ë¡œê±´ ë°°ì—´
      const slogans = [
        "í•œ ì¤„ í•œ ì¤„, ì½”ë“œì˜ ì˜ë„ë¥¼ ê³ ë¯¼í•´ ë´…ì‹œë‹¤.",
        "í‹€ë ¤ë„ ê´œì°®ì•„ìš”. ì‹œë„í•˜ëŠ” ê²Œ ë” ì¤‘ìš”í•´ìš”!",
        "ë„ì „í•  ì¤€ë¹„ ë˜ì…¨ë‚˜ìš”? ë‹¹ì‹ ì´ë¼ë©´ í•  ìˆ˜ ìˆì–´ìš”!",
        "ì—¬ê¸°ì—” ì–´ë–¤ ì•„ì´ë””ì–´ê°€ ìˆ¨ì–´ ìˆì„ê¹Œìš”?",
        "ì´ ì½”ë“œ, ê³¼ì—° ë¬´ìŠ¨ ì¼ì„ í• ê¹Œìš”?",
      ];

      // ë¬¸ì œë³„ë¡œ ê³ ì •ëœ ìŠ¬ë¡œê±´ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
      function getSloganForProblem(problemId) {
        // problemIdì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
        const numMatch = problemId.match(/\d+/);
        const num = numMatch ? parseInt(numMatch[0]) : 0;

        // ë¬¸ì œ ë²ˆí˜¸ì— ë”°ë¼ ê³ ì •ëœ ìŠ¬ë¡œê±´ ì„ íƒ
        return slogans[num % slogans.length];
      }

      // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
      async function loadProblems() {
        try {
          const [problems, submissions] = await Promise.all([
            apiCall("/api/problems"),
            apiCall("/api/my-submissions"),
          ]);

          if (!problems || !submissions) return;

          const submissionMap = new Map();
          submissions.forEach((sub) => {
            submissionMap.set(sub.problem_id, sub);
          });

          displayProblems(problems, submissionMap);
        } catch (error) {
          console.error("Error loading problems:", error);
          document.getElementById("loadingMessage").style.display = "none";
          document.getElementById("errorMessage").style.display = "block";
          document.getElementById("errorMessage").textContent =
            "ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
        }
      }

      // ë¬¸ì œ ëª©ë¡ í‘œì‹œ
      function displayProblems(problems, submissionMap) {
        const grid = document.getElementById("problemsGrid");
        const loading = document.getElementById("loadingMessage");

        loading.style.display = "none";
        grid.style.display = "grid";

        grid.innerHTML = problems
          .map((problem) => {
            const submission = submissionMap.get(problem.problem_id);
            const isSubmitted = !!submission;

            // ë¬¸ì œë³„ ê³ ì • ìŠ¬ë¡œê±´ í‘œì‹œ
            const slogan = getSloganForProblem(problem.problem_id);

            return `
                    <div class="problem-card">
                        <div class="problem-header">
                            <div class="problem-id">#${problem.problem_id}</div>
                            <h3 class="problem-title">${problem.title}</h3>
                        </div>
                        <div class="problem-content">${slogan}</div>
                        <div class="problem-footer">
                            <div class="max-score">ìµœëŒ€ ${
                              problem.max_score
                            }ì </div>
                            <button class="solve-btn" data-problem-id="${
                              problem.problem_id
                            }">
                                ${isSubmitted ? "ë‹¤ì‹œ í’€ê¸°" : "ë¬¸ì œ í’€ê¸°"}
                            </button>
                        </div>
                        <div class="submission-status">
                            <span class="status-badge ${
                              isSubmitted
                                ? "status-submitted"
                                : "status-not-submitted"
                            }">
                                ${isSubmitted ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ"}
                            </span>
                            ${
                              isSubmitted
                                ? `<span style="font-size: 12px; color: #666;">
                                ${new Date(
                                  submission.submitted_at
                                ).toLocaleString("ko-KR")}
                            </span>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");

        // ë¬¸ì œ í’€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.querySelectorAll('.solve-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-problem-id');
            solveProblem(problemId);
          });
        });
      }

      // ë¬¸ì œ í’€ê¸°
      function solveProblem(problemId) {
        window.location.href = `/problem/${problemId}`;
      }

      // íŠœí† ë¦¬ì–¼ ì‹œì‘
      function startTutorial() {
        window.location.href = '/tutorial1';
      }

      // íŠœí† ë¦¬ì–¼ ê±´ë„ˆë›°ê¸°
      function skipTutorial() {
        localStorage.setItem("tutorial_completed", "true");
        document.getElementById("tutorialNotice").style.display = "none";
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener("DOMContentLoaded", function () {
        if (!checkAuth()) return;

        // íŠœí† ë¦¬ì–¼ ìƒíƒœ í™•ì¸
        if (!checkTutorialStatus()) {
          document.getElementById("tutorialNotice").style.display = "block";
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("logout-btn").addEventListener("click", logout);
        document.getElementById("start-tutorial").addEventListener("click", startTutorial);
        document.getElementById("skip-tutorial").addEventListener("click", skipTutorial);

        // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
        loadProblems();
      });
    </script>
  </body>
</html>
