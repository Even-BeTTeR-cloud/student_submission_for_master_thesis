<script>
      console.log("ğŸ“‹ Problems í˜ì´ì§€ ë¡œë“œë¨");

      // ì¸ì¦ í™•ì¸
      function checkAuth() {
        const token = localStorage.getItem("access_token");
        const userName = localStorage.getItem("user_name");

        if (!token) {
          console.log("âŒ í† í° ì—†ìŒ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™");
          window.location.href = "/";
          return false;
        }

        document.getElementById("userName").textContent = userName || "ì‚¬ìš©ì";
        console.log("âœ… í† í° í™•ì¸ë¨, Problems í˜ì´ì§€ ì§„í–‰");
        
        // --- ë‹¤ìŒ ì¤„ë“¤ì€ ì‚­ì œí•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ---
        // try {
        //     const userResponse = await apiCall("/api/user-status"); 
        //     if (userResponse && userResponse.tutorial_completed === false) {
        //         console.log("âš ï¸ íŠœí† ë¦¬ì–¼ ë¯¸ì™„ë£Œ, Tutorial1 í˜ì´ì§€ë¡œ ì´ë™");
        //         window.location.replace("/tutorial1"); 
        //         return false;
        //     }
        // } catch (error) {
        //     console.error("âŒ ì‚¬ìš©ì ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
        // }
        // --- ì—¬ê¸°ê¹Œì§€ ì‚­ì œí•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ---

        return true;
      }

      // ë¡œê·¸ì•„ì›ƒ - íˆìŠ¤í† ë¦¬ ì™„ì „ ì´ˆê¸°í™”
      function logout() {
        console.log("ğŸšª ë¡œê·¸ì•„ì›ƒ ì‹¤í–‰");
        
        // localStorage ì™„ì „ ì‚­ì œ
        localStorage.clear();
        
        // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ë„ ì‚­ì œ
        sessionStorage.clear();
        
        console.log("ğŸ§¹ ëª¨ë“  ì €ì¥ì†Œ ì´ˆê¸°í™” ì™„ë£Œ");
        
        // íˆìŠ¤í† ë¦¬ ì™„ì „ ì´ˆê¸°í™”í•˜ê³  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.replace("/");
      }

      // API í˜¸ì¶œ í—¬í¼
      async function apiCall(url, options = {}) {
        const token = localStorage.getItem("access_token");

        const defaultOptions = {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            ...options.headers,
          },
        };

        const response = await fetch(url, { ...options, ...defaultOptions });

        if (response.status === 401) {
          // í† í°ì´ ë§Œë£Œëœ ê²½ìš°
          console.log("âŒ í† í° ë§Œë£Œ, ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬");
          logout();
          return null;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
      }

      // ìŠ¬ë¡œê±´ ë°°ì—´
      const slogans = [
        "í•œ ì¤„ í•œ ì¤„, ì½”ë“œì˜ ì˜ë„ë¥¼ ê³ ë¯¼í•´ ë´…ì‹œë‹¤.",
        "í‹€ë ¤ë„ ê´œì°®ì•„ìš”. ì‹œë„í•˜ëŠ” ê²Œ ë” ì¤‘ìš”í•´ìš”!",
        "ë„ì „í•  ì¤€ë¹„ ë˜ì…¨ë‚˜ìš”? ë‹¹ì‹ ì´ë¼ë©´ í•  ìˆ˜ ìˆì–´ìš”!",
        "ì—¬ê¸°ì—” ì–´ë–¤ ì•„ì´ë””ì–´ê°€ ìˆ¨ì–´ ìˆì„ê¹Œìš”?",
        "ì´ ì½”ë“œ, ê³¼ì—° ë¬´ìŠ¨ ì¼ì„ í• ê¹Œìš”?",
      ];

      // ë¬¸ì œë³„ë¡œ ê³ ì •ëœ ìŠ¬ë¡œê±´ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
      function getSloganForProblem(problemId) {
        // problemIdì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
        const numMatch = problemId.match(/\d+/);
        const num = numMatch ? parseInt(numMatch[0]) : 0;

        // ë¬¸ì œ ë²ˆí˜¸ì— ë”°ë¼ ê³ ì •ëœ ìŠ¬ë¡œê±´ ì„ íƒ
        return slogans[num % slogans.length];
      }

      // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
      async function loadProblems() {
        console.log("ğŸ“‹ ë¬¸ì œ ëª©ë¡ ë¡œë“œ ì‹œì‘");
        
        try {
          const [problems, submissions] = await Promise.all([
            apiCall("/api/problems"),
            apiCall("/api/my-submissions"),
          ]);

          if (!problems || !submissions) return;

          console.log(`ğŸ“Š ë¬¸ì œ ${problems.length}ê°œ, ì œì¶œ ë‚´ì—­ ${submissions.length}ê°œ ë¡œë“œë¨`);

          const submissionMap = new Map();
          submissions.forEach((sub) => {
            submissionMap.set(sub.problem_id, sub);
          });

          displayProblems(problems, submissionMap);
        } catch (error) {
          console.error("âŒ ë¬¸ì œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
          document.getElementById("loadingMessage").style.display = "none";
          document.getElementById("errorMessage").style.display = "block";
          document.getElementById("errorMessage").textContent =
            "ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
        }
      }

      // ë¬¸ì œ ëª©ë¡ í‘œì‹œ
      function displayProblems(problems, submissionMap) {
        const grid = document.getElementById("problemsGrid");
        const loading = document.getElementById("loadingMessage");

        loading.style.display = "none";
        grid.style.display = "grid";

        grid.innerHTML = problems
          .map((problem) => {
            const submission = submissionMap.get(problem.problem_id);
            const isSubmitted = !!submission;

            // ë¬¸ì œë³„ ê³ ì • ìŠ¬ë¡œê±´ í‘œì‹œ
            const slogan = getSloganForProblem(problem.problem_id);

            return `
                    <div class="problem-card">
                        <div class="problem-header">
                            <div class="problem-id">#${problem.problem_id}</div>
                            <h3 class="problem-title">${problem.title}</h3>
                        </div>
                        <div class="problem-content">${slogan}</div>
                        <div class="problem-footer">
                            <div class="max-score">ìµœëŒ€ ${
                              problem.max_score
                            }ì </div>
                            <button class="solve-btn" data-problem-id="${
                              problem.problem_id
                            }">
                                ${isSubmitted ? "ë‹¤ì‹œ í’€ê¸°" : "ë¬¸ì œ í’€ê¸°"}
                            </button>
                        </div>
                        <div class="submission-status">
                            <span class="status-badge ${
                              isSubmitted
                                ? "status-submitted"
                                : "status-not-submitted"
                            }">
                                ${isSubmitted ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ"}
                            </span>
                            ${
                              isSubmitted
                                ? `<span style="font-size: 12px; color: #666;">
                                ${new Date(
                                  submission.submitted_at
                                ).toLocaleString("ko-KR")}
                            </span>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");

        // ë¬¸ì œ í’€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.querySelectorAll('.solve-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-problem-id');
            solveProblem(problemId);
          });
        });

        console.log("ğŸ“‹ ë¬¸ì œ ëª©ë¡ í‘œì‹œ ì™„ë£Œ");
      }

      // ë¬¸ì œ í’€ê¸°
      function solveProblem(problemId) {
        console.log(`ğŸ“ ë¬¸ì œ ${problemId} í’€ê¸° ì‹œì‘`);
        window.location.href = `/problem/${problemId}`;
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸ“‹ Problems í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘");
        
        if (!checkAuth()) return;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById("logout-btn").addEventListener("click", logout);

        // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
        loadProblems();
        
        console.log("ğŸ“‹ Problems í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ");
      });
    </script>
