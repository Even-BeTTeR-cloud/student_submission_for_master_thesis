<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>문제 목록 - 학생 답안 제출 시스템</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-name {
        font-size: 16px;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* 브레드크럼 네비게이션 */
      .breadcrumb {
        background: #f8f9fa;
        padding: 12px 20px;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
      }

      .breadcrumb a {
        color: #667eea;
        text-decoration: none;
        margin-right: 5px;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      .breadcrumb .separator {
        margin: 0 8px;
        color: #6c757d;
      }

      .breadcrumb .current {
        color: #333;
        font-weight: bold;
      }

      .container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .problems-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .problem-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        border-left: 4px solid #667eea;
      }

      .problem-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .problem-header {
        margin-bottom: 15px;
      }

      .problem-id {
        color: #667eea;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .problem-title {
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
      }

      .problem-content {
        color: #667eea;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 20px;
        font-style: italic;
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .problem-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .max-score {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
      }

      .solve-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.3s;
      }

      .solve-btn:hover {
        transform: translateY(-2px);
      }

      .submission-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-submitted {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-not-submitted {
        background: #fff3e0;
        color: #f57c00;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #f44336;
      }

      .section-title {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
      }

      .section-subtitle {
        color: #666;
        font-size: 16px;
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <h1>학생 답안 제출 시스템</h1>
        <div class="user-info">
          <span class="user-name" id="userName">로딩 중...</span>
          <button class="logout-btn" id="logout-btn">로그아웃</button>
        </div>
      </div>
    </div>

    <!-- 브레드크럼 네비게이션 -->
    <div class="breadcrumb">
      <a href="/tutorial0">튜토리얼</a>
      <span class="separator">></span>
      <span class="current">문제 목록</span>
    </div>

    <div class="container">
      <h2 class="section-title">문제 목록</h2>
      <p class="section-subtitle">아래 문제들을 하나씩 해결해봐요!</p>

      <div id="loadingMessage" class="loading">문제를 불러오는 중...</div>
      <div id="errorMessage" class="error" style="display: none"></div>
      <div id="problemsGrid" class="problems-grid" style="display: none"></div>
    </div>

    <script>
      console.log("📋 Problems 페이지 로드됨");

      // 인증 및 흐름 관리 함수들
      function checkAuthAndRedirect() {
        const token = localStorage.getItem('access_token');
        const userType = localStorage.getItem('user_type');
        
        if (!token) {
          window.location.replace('/');
          return false;
        }
        
        if (userType === 'teacher') {
          window.location.replace('/teacher/dashboard');
          return false;
        }
        
        return true;
      }

      function checkTutorialStatus() {
        const userType = localStorage.getItem('user_type');
        const tutorialCompleted = localStorage.getItem('tutorial_completed');
        
        if (userType === 'student' && tutorialCompleted !== 'true') {
          // 튜토리얼을 완료하지 않았으면 첫 번째 튜토리얼로
          window.location.replace('/tutorial0');
          return false;
        }
        return true;
      }

      // 인증 확인
      function checkAuth() {
        const token = localStorage.getItem("access_token");
        const userName = localStorage.getItem("user_name");

        if (!token) {
          console.log("❌ 토큰 없음, 로그인 페이지로 이동");
          window.location.href = "/";
          return false;
        }

        const userNameElement = document.getElementById("userName");
        if (userNameElement) {
            userNameElement.textContent = userName || "사용자";
        } else {
            console.warn("⚠️ 'userName' 요소를 찾을 수 없습니다.");
        }

        console.log("✅ 토큰 확인됨, Problems 페이지 진행");
        return true;
      }

      // 로그아웃 - 히스토리 완전 초기화
      function logout() {
        console.log("🚪 로그아웃 실행");
        
        // localStorage 완전 삭제
        localStorage.clear();
        
        // 세션 스토리지도 삭제
        sessionStorage.clear();
        
        console.log("🧹 모든 저장소 초기화 완료");
        
        // 히스토리 완전 초기화하고 로그인 페이지로 이동
        window.location.replace("/");
      }

      // API 호출 헬퍼
      async function apiCall(url, options = {}) {
        const token = localStorage.getItem("access_token");

        const defaultOptions = {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            ...options.headers,
          },
        };

        const response = await fetch(url, { ...options, ...defaultOptions });

        if (response.status === 401) {
          // 토큰이 만료된 경우
          console.log("❌ 토큰 만료, 로그아웃 처리");
          logout();
          return null;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
      }

      // 슬로건 배열
      const slogans = [
        "한 줄 한 줄, 코드의 의도를 고민해 봅시다.",
        "틀려도 괜찮아요. 시도하는 게 더 중요해요!",
        "도전할 준비 되셨나요? 당신이라면 할 수 있어요!",
        "여기엔 어떤 아이디어가 숨어 있을까요?",
        "이 코드, 과연 무슨 일을 할까요?",
      ];

      // 문제별로 고정된 슬로건을 반환하는 함수
      function getSloganForProblem(problemId) {
        // problemId에서 숫자만 추출
        const numMatch = problemId.match(/\d+/);
        const num = numMatch ? parseInt(numMatch[0]) : 0;

        // 문제 번호에 따라 고정된 슬로건 선택
        return slogans[num % slogans.length];
      }

      // 문제 목록 로드
      async function loadProblems() {
        console.log("📋 문제 목록 로드 시작");
        
        try {
          const [problems, submissions] = await Promise.all([
            apiCall("/api/problems"),
            apiCall("/api/my-submissions"),
          ]);

          if (!problems || !submissions) return;

          console.log(`📊 문제 ${problems.length}개, 제출 내역 ${submissions.length}개 로드됨`);

          const submissionMap = new Map();
          submissions.forEach((sub) => {
            submissionMap.set(sub.problem_id, sub);
          });

          displayProblems(problems, submissionMap);
        } catch (error) {
          console.error("❌ 문제 목록 로드 오류:", error);
          document.getElementById("loadingMessage").style.display = "none";
          document.getElementById("errorMessage").style.display = "block";
          document.getElementById("errorMessage").textContent =
            "문제를 불러오는 중 오류가 발생했습니다. 페이지를 새로고침 해주세요.";
        }
      }

      // 문제 목록 표시
      function displayProblems(problems, submissionMap) {
        const grid = document.getElementById("problemsGrid");
        const loading = document.getElementById("loadingMessage");

        loading.style.display = "none";
        grid.style.display = "grid";

        grid.innerHTML = problems
          .map((problem) => {
            const submission = submissionMap.get(problem.problem_id);
            const isSubmitted = !!submission;

            // 문제별 고정 슬로건 표시
            const slogan = getSloganForProblem(problem.problem_id);

            return `
                    <div class="problem-card">
                        <div class="problem-header">
                            <div class="problem-id">#${problem.problem_id}</div>
                            <h3 class="problem-title">${problem.title}</h3>
                        </div>
                        <div class="problem-content">${slogan}</div>
                        <div class="problem-footer">
                            <div class="max-score">최대 ${
                              problem.max_score
                            }점</div>
                            <button class="solve-btn" data-problem-id="${
                              problem.problem_id
                            }">
                                ${isSubmitted ? "다시 풀기" : "문제 풀기"}
                            </button>
                        </div>
                        <div class="submission-status">
                            <span class="status-badge ${
                              isSubmitted
                                ? "status-submitted"
                                : "status-not-submitted"
                            }">
                                ${isSubmitted ? "제출 완료" : "미제출"}
                            </span>
                            ${
                              isSubmitted
                                ? `<span style="font-size: 12px; color: #666;">
                                ${new Date(
                                  submission.submitted_at
                                ).toLocaleString("ko-KR")}
                            </span>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");

        // 문제 풀기 버튼 이벤트 리스너 추가
        document.querySelectorAll('.solve-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const problemId = this.getAttribute('data-problem-id');
            solveProblem(problemId);
          });
        });

        console.log("📋 문제 목록 표시 완료");
      }

      // 문제 풀기
      function solveProblem(problemId) {
        console.log(`🔍 문제 ${problemId} 풀기 시작`);
        window.location.href = `/problem/${problemId}`;
      }

      // 페이지 로드 시 실행
      document.addEventListener("DOMContentLoaded", function () {
        console.log("📋 Problems 페이지 초기화 시작");
        
        if (!checkAuthAndRedirect()) return;
        if (!checkTutorialStatus()) return;
        if (!checkAuth()) return;

        // 이벤트 리스너 등록
        document.getElementById("logout-btn").addEventListener("click", logout);

        // 문제 목록 로드
        loadProblems();
        
        console.log("📋 Problems 페이지 초기화 완료");
      });
    </script>
  </body>
</html>
